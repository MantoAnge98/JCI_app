<div class="container">
  <table class="table text-center">
    <thead class="thead-light">
      <tr>
        <th>Image</th> 
        <th>Name</th> 
        <th>First Name</th> 
        <th>Telephone</th>
        <th>Group</th> 
        <th>Email</th> 
        <th>Devise</th>
        <th>Member Since</th>  
        <th>Action</th>
      </tr>
    </thead> 
    <tbody>
      <tr> 
        <td><%= image_tag @user.avatar_thumbnail, style:"width:80px;height:80px"%></td>
        <td><%= @user.name %></td>
        <td><%= @user.first_name %></td>
        <td><%= @user.telephone %></td>
        <td> 
          <% if @user.group%>
            <%= @user.group.name %>
          <% end%>
        </td>
        <td><%= @user.email %></td>
        <% if @user.setting%>
          <td> 
            <%= @user.setting.devise%>
          </td>
        <%end%> 
        <td><%= @user.added_since %></td> 
        <td>
          <%= link_to  "Back", admin_users_path, class: "btn btn-secondary" %> |
          <%= link_to "Edit", edit_admin_user_path(@user), class: "btn btn-secondary" %> |
          <%= link_to "Delete", admin_group_path(@user.id), method: :delete, data: {confirm: 'Are you sure?'}, class: "btn btn-secondary"%> 
        </td>
      </tr>
    </tbody>  
  </table> 

  <br>
    <%= link_to "New Payment", new_admin_payment_path(@user), class: "btn btn-secondary text-center" %>
  <br>
  <h4>Payment Information</h4> 
  <br>
  <table class="table text-center">
    <thead class="thead-light">
      <tr>
        <th>Date Payment</th> 
        <th>Note</th> 
        <th>Payment Amount</th>  
        <!--<th>Action</th>-->
      </tr>
    </thead> 
    <tbody> 
    <% nbre = 0 %>
      <% @payment.each do |payment| %> 
        <tr>   
          <% if @user.id == payment.user_id%>         
            <td><%= payment.date_payment %></td>
            <td><%= payment.note %></td>
            <td><%= payment.pay_amount %></td>
           <!-- <td>
              <%#= link_to  "Back", admin_users_path, class: "btn btn-secondary" %> |
              <%#= link_to "Edit", edit_admin_payment_path(user.id), class: "btn btn-secondary" %> 
              <%#= link_to "Delete", admin_group_path(@user.id), method: :delete, data: {confirm: 'Are you sure?'}, class: "btn btn-secondary"%> 
            </td> -->
            
            <%#= @payment.where(user_id: payment.user_id).count%>
            
            <% if payment.present?%>   
              <% nbre += payment.pay_amount %>
              <% nbre%>
            <%end%>
          <%end%>
        </tr>   
      <%end %> 
    </tbody>  
  </table>
  <p class="text-center">
    Total payment Amount = <%= nbre%>, <%= @user.setting.devise%>
    <br>
    <%if @user.added_since.year < Date.today.year%>
      <% date = (Date.today.year - @user.added_since.year).to_i%>
      <% date = (date + 1)%>
      <% total = (date*@user.setting.amount_due)%>
      <% if total > nbre %>
        <br> 
        You must pay <%= nbre_total = (total - nbre)%>, <%= @user.setting.devise%>
      <% elsif total < nbre%>
        <p>You are in the standards. Your surplus is <%= nbre_total = nbre - total%></p>
          <%year = (nbre_total.to_f / @user.setting.amount_due.to_f).to_f %>
          <%= year.to_i%> , year(s)
          <% recup_val_month = year - year.to_i%>
          <% month = (recup_val_month.to_f * 12)%>
          <%= month.to_i%>, month(s)
      <%else%>
        <p>You are in the standards.</p>
      <%end%>
    <% elsif  @user.added_since.year > Date.today.year%>
      ...
    <%else%> 
      <!--
        You must pay <%#= total = (nbre - @user.setting.amount_due)%>, <%#= @user.setting.devise%>
      -->
      <% date = (Date.today.year - @user.added_since.year).to_i%>
      <% date = (date + 1)%>
      <% total = (date*@user.setting.amount_due)%>
      <% if total > nbre %>
        <br> 
        You must pay <%= nbre_total = (total - nbre)%>, <%= @user.setting.devise%>
      <% elsif total < nbre%>
        <p class="text-center">You are in the standards. Your surplus is <%= nbre_total = nbre - total%></p>
          <%year = (nbre_total.to_f / @user.setting.amount_due.to_f).to_f %>
        <p class="text-center"><%= year.to_i%> , year(s)
          <% recup_val_month = year - year.to_i%>
          <% month = (recup_val_month.to_f * 12)%>
          <%= month.to_i%>, month(s)
        </p>
      <%else%>
        <p class="text-center">You are in the standards.</p>
      <%end%> 
    <%end%> 
  </p>
</div>